<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastKey Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>.hidden { display: none; }</style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <div id="step-1">
            <h2 class="text-2xl font-bold mb-6">Chọn sản phẩm</h2>
            <div id="product-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
        </div>

        <div id="step-2" class="hidden max-w-md mx-auto bg-white p-6 rounded-2xl shadow-sm border">
            <h2 class="text-xl font-bold mb-4 text-center">Thông tin nhận hàng</h2>
            <input type="email" id="email" placeholder="Email của bạn..." class="w-full p-3 border rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="createOrder()" id="btn-confirm" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Xác nhận đơn hàng</button>
        </div>

        <div id="step-3" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8 bg-white p-6 rounded-2xl shadow-sm border">
            <div>
                <h2 class="font-bold text-lg mb-4">Chi tiết đơn hàng</h2>
                <p id="info-name" class="py-2 border-b"></p>
                <p id="info-id" class="py-2 border-b font-mono text-blue-600"></p>
                <p id="info-total" class="py-2 text-xl font-bold text-blue-600"></p>
            </div>
            <div class="text-center">
                <div id="payment-loading">
                    <img id="qr-img" class="mx-auto w-48 h-48 mb-4 border p-2 rounded-lg">
                    <p class="animate-pulse text-blue-600 font-medium">Đang chờ thanh toán...</p>
                    <div class="mt-4 bg-slate-100 p-3 rounded font-mono font-bold" id="info-content"></div>
                </div>
                <div id="payment-success" class="hidden">
                    <div class="text-green-600 text-5xl mb-2">✔</div>
                    <h2 class="text-2xl font-bold">Thành công!</h2>
                    <p class="mb-4">Vui lòng kiểm tra email.</p>
                    <button onclick="location.reload()" class="bg-black text-white px-6 py-2 rounded-lg">Quay lại</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let sel = {};
        async function load() {
            const res = await fetch('/api/get-products');
            const data = await res.json();
            document.getElementById('product-grid').innerHTML = data.map(p => `
                <div class="bg-white p-5 rounded-2xl border shadow-sm">
                    <h3 class="font-bold text-lg">${p.name}</h3>
                    <p class="text-2xl font-bold text-blue-600 my-3">${p.price.toLocaleString()}đ</p>
                    <button onclick="selP('${p.product_code}','${p.name}',${p.price})" class="w-full bg-slate-100 py-2 rounded-lg font-bold hover:bg-blue-600 hover:text-white">Mua ngay</button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function selP(c,n,p){ sel={c,n,p}; document.getElementById('step-1').classList.add('hidden'); document.getElementById('step-2').classList.remove('hidden'); }

        async function createOrder() {
            const email = document.getElementById('email').value;
            if(!email.includes('@')) return alert("Email sai!");
            const id = "ORD" + Math.floor(Math.random()*900000);
            
            document.getElementById('btn-confirm').innerText = "Đang xử lý...";
            await fetch('/api/create-order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({orderId: id, productCode: sel.c, amount: sel.p, email: email})
            });

            document.getElementById('info-name').innerText = sel.n;
            document.getElementById('info-id').innerText = id;
            document.getElementById('info-total').innerText = sel.p.toLocaleString() + "đ";
            document.getElementById('info-content').innerText = id;
            document.getElementById('qr-img').src = `https://qr.sepay.vn/img?acc=134150399&bank=ACB&amount=${sel.p}&des=${id}`;
            
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.remove('hidden');

            setInterval(async () => {
                const r = await fetch(`/api/check-status?orderId=${id}`);
                const d = await r.json();
                if(d.status === 'completed') {
                    document.getElementById('payment-loading').classList.add('hidden');
                    document.getElementById('payment-success').classList.remove('hidden');
                }
            }, 3000);
        }
        window.onload = load;
    </script>
</body>
</html>
