<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh Toán An Toàn | KeyStore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .product-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .loading-shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased text-slate-900">

<div class="max-w-md mx-auto min-h-screen flex flex-col px-4 py-6">
    <header class="flex items-center justify-between mb-8">
        <div class="flex items-center space-x-2">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
                <i data-lucide="zap" class="fill-current"></i>
            </div>
            <span class="text-xl font-extrabold tracking-tight">FAST<span class="text-blue-600">KEY</span></span>
        </div>
        <div id="stock-status" class="flex items-center space-x-1 px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 text-[10px] font-bold uppercase tracking-wider">
            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
            <span>Đang còn hàng</span>
        </div>
    </header>

    <main class="flex-1">
        <div class="product-card rounded-[2.5rem] shadow-2xl shadow-blue-900/5 p-6 md:p-8 relative overflow-hidden">
            <div id="checkout-view" class="space-y-6">
                <div class="text-center space-y-4">
                    <div class="relative inline-block">
                        <img id="p-image" src="https://cdn-icons-png.flaticon.com/512/5968/5968313.png" class="w-28 h-28 mx-auto object-contain drop-shadow-2xl">
                    </div>
                    <div>
                        <h2 id="p-name" class="text-2xl font-extrabold text-slate-800 leading-tight">Đang tải sản phẩm...</h2>
                        <p id="p-desc" class="text-slate-500 text-sm mt-1 px-4">Đang kết nối đến kho dữ liệu...</p>
                        <div id="p-warranty" class="mt-2 inline-flex items-center text-[11px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-md uppercase tracking-wide">
                            <i data-lucide="shield-check" class="w-3 h-3 mr-1"></i> BẢO HÀNH TRỌN ĐỜI
                        </div>
                    </div>
                </div>

                <div class="space-y-4 pt-6 border-t border-slate-100">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1.5">
                            <label class="text-[11px] font-bold text-slate-400 uppercase ml-1">Số lượng</label>
                            <input type="number" id="qty" value="1" min="1" onchange="calculateTotal()" class="w-full px-4 py-3 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-blue-500 focus:bg-white outline-none transition-all font-bold">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[11px] font-bold text-slate-400 uppercase ml-1">Mã giảm giá</label>
                            <div class="flex space-x-2">
                                <input type="text" id="coupon" placeholder="CODE" class="w-full px-4 py-3 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-blue-500 focus:bg-white outline-none transition-all font-bold uppercase placeholder:font-normal text-sm">
                                <button onclick="checkCoupon()" class="bg-slate-900 text-white p-3 rounded-2xl hover:bg-blue-600 transition-colors shadow-lg shadow-slate-200">
                                    <i data-lucide="ticket" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-1.5 text-left">
                        <label class="text-[11px] font-bold text-slate-400 uppercase ml-1">Thông tin nhận Key (Email)</label>
                        <input type="email" id="cust_email" placeholder="ten-cua-ban@gmail.com" class="w-full px-4 py-3 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-blue-500 focus:bg-white outline-none transition-all">
                    </div>

                    <div class="space-y-1.5 text-left">
                        <label class="text-[11px] font-bold text-slate-400 uppercase ml-1">Số điện thoại (Zalo)</label>
                        <input type="tel" id="cust_phone" placeholder="09xxxxxxxx" class="w-full px-4 py-3 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-blue-500 focus:bg-white outline-none transition-all">
                    </div>
                </div>

                <div class="bg-slate-900 rounded-3xl p-5 text-white shadow-xl shadow-blue-900/20">
                    <div class="flex justify-between text-xs opacity-60 mb-1">
                        <span>Giá gốc</span>
                        <span id="txt-subtotal">0đ</span>
                    </div>
                    <div id="row-discount" class="hidden flex justify-between text-xs text-emerald-400 mb-1">
                        <span>Giảm giá</span>
                        <span id="txt-discount">-0đ</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-sm font-bold">Tổng cộng</span>
                        <span id="txt-total" class="text-2xl font-black text-blue-400">0đ</span>
                    </div>
                </div>

                <button onclick="submitOrder()" id="btn-pay" class="w-full py-5 bg-blue-600 text-white rounded-[1.5rem] font-extrabold shadow-xl shadow-blue-200 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center space-x-2">
                    <span>THANH TOÁN NGAY</span>
                    <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>

            <div id="payment-view" class="hidden py-4 text-center space-y-6">
                <div class="space-y-2">
                    <h3 class="text-xl font-extrabold text-slate-800">Quét mã VietQR</h3>
                    <p class="text-xs text-slate-400">Giao dịch được xử lý tự động bởi SePay</p>
                </div>
                
                <div class="bg-white p-3 border-2 border-slate-100 rounded-[2rem] inline-block shadow-inner relative">
                    <img id="qr-img" src="" class="w-64 h-64 object-contain">
                </div>

                <div class="flex items-center justify-center space-x-3 text-blue-600 bg-blue-50 py-3 px-6 rounded-2xl mx-auto w-fit">
                    <div class="spinner"></div>
                    <span class="text-xs font-bold uppercase tracking-wider">Đang chờ thanh toán...</span>
                </div>

                <div class="text-slate-400 text-[10px] space-y-1">
                    <p>Vui lòng giữ nguyên nội dung chuyển khoản</p>
                    <p>Sau khi thanh toán, Key sẽ được gửi vào Email của bạn</p>
                </div>

                <button onclick="location.reload()" class="text-slate-400 text-xs font-bold uppercase hover:text-slate-900 transition-colors">
                    Hủy giao dịch
                </button>
            </div>
        </div>
    </main>

    <footer class="mt-8 text-center text-slate-400 text-[10px] font-medium tracking-widest uppercase">
        Secure Payment Gateway &bull; Powered by Vercel & Supabase
    </footer>
</div>

<script>
    // Initialize Icons
    lucide.createIcons();

    let product = null;
    let discountPercent = 0;

    // 1. Lấy thông tin sản phẩm từ API khi Load trang
    window.onload = async () => {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code') || 'WIN11PRO'; // Mặc định

        try {
            const res = await fetch(`/api/get-product?code=${code}`);
            if (res.ok) {
                product = await res.json();
                renderProduct();
            } else {
                document.getElementById('p-name').innerText = "Lỗi sản phẩm!";
            }
        } catch (e) {
            console.error("Lỗi kết nối API");
        }
    };

    function renderProduct() {
        document.getElementById('p-image').src = product.image_url;
        document.getElementById('p-name').innerText = product.name;
        document.getElementById('p-desc').innerText = product.description;
        document.getElementById('p-warranty').innerText = product.warranty || "Bảo hành 24/7";
        calculateTotal();
    }

    function calculateTotal() {
        if (!product) return;
        const qty = parseInt(document.getElementById('qty').value) || 1;
        const subtotal = product.price * qty;
        const discountAmt = subtotal * (discountPercent / 100);
        const total = subtotal - discountAmt;

        document.getElementById('txt-subtotal').innerText = subtotal.toLocaleString('vi-VN') + 'đ';
        document.getElementById('txt-total').innerText = total.toLocaleString('vi-VN') + 'đ';
        
        if (discountPercent > 0) {
            document.getElementById('row-discount').classList.remove('hidden');
            document.getElementById('txt-discount').innerText = '-' + discountAmt.toLocaleString('vi-VN') + 'đ';
        }
    }

    async function checkCoupon() {
        const code = document.getElementById('coupon').value.trim();
        if (!code) return;
        
        try {
            const res = await fetch(`/api/check-coupon?code=${code}`);
            if (res.ok) {
                const data = await res.json();
                discountPercent = data.discount_percent;
                alert(`Áp dụng mã giảm giá ${discountPercent}% thành công!`);
                calculateTotal();
            } else {
                alert("Mã giảm giá không hợp lệ");
                discountPercent = 0;
                calculateTotal();
            }
        } catch (e) {}
    }

    async function submitOrder() {
        const email = document.getElementById('cust_email').value;
        const phone = document.getElementById('cust_phone').value;
        const total = document.getElementById('txt-total').innerText.replace(/\D/g,'');

        if (!email.includes('@') || phone.length < 10) {
            alert("Vui lòng nhập Email và Số điện thoại chính xác!");
            return;
        }

        const btn = document.getElementById('btn-pay');
        btn.disabled = true;
        btn.innerHTML = `<div class="spinner !border-white !border-t-transparent"></div>`;

        const orderId = "ORD" + Math.floor(100000 + Math.random() * 899999);

        try {
            const res = await fetch('/api/create-order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ order_id: orderId, email, phone, total })
            });

            if (res.ok) {
                // VietQR API Link (Thay STK của bạn ở đây)
                const STK = "123456789"; 
                const NGAN_HANG = "MB"; // Mã ngân hàng
                const qrUrl = `https://img.vietqr.io/image/${NGAN_HANG}-${STK}-compact2.png?amount=${total}&addInfo=${orderId}_${phone}`;
                
                document.getElementById('qr-img').src = qrUrl;
                document.getElementById('checkout-view').classList.add('hidden');
                document.getElementById('payment-view').classList.remove('hidden');
            }
        } catch (e) {
            alert("Lỗi tạo đơn hàng!");
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
