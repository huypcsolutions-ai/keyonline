<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyStore Pro - Hệ Thống Bán Key Tự Động</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; }
        .product-card:hover { transform: translateY(-8px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">

<div class="max-w-6xl mx-auto px-4 py-8">
    <header class="flex justify-between items-center mb-12">
        <div class="flex items-center space-x-2 cursor-pointer" onclick="showCatalog()">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
                <i data-lucide="zap" class="fill-current"></i>
            </div>
            <span class="text-2xl font-extrabold tracking-tight italic">FAST<span class="text-blue-600">KEY</span></span>
        </div>
    </header>

    <div id="catalog-view" class="space-y-8">
        <div class="text-center space-y-2">
            <h2 class="text-4xl font-extrabold text-slate-900">Kho Key Bản Quyền</h2>
            <p class="text-slate-500">Chọn sản phẩm bạn cần, nhận mã ngay sau khi thanh toán</p>
        </div>
        <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="col-span-full text-center py-20">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div>
            </div>
        </div>
    </div>

    <div id="checkout-view" class="hidden max-w-xl mx-auto">
        <button onclick="showCatalog()" class="mb-6 text-slate-500 text-sm font-bold flex items-center hover:text-blue-600 transition">
            <i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i> QUAY LẠI CỬA HÀNG
        </button>

        <div class="glass rounded-[2.5rem] shadow-2xl p-6 md:p-8 space-y-8">
            <div class="flex items-center space-x-4 bg-white p-4 rounded-3xl border border-slate-100">
                <img id="check-img" src="" class="w-20 h-20 object-contain">
                <div>
                    <h3 id="check-name" class="text-xl font-extrabold text-slate-800"></h3>
                    <p id="check-warranty" class="text-xs font-bold text-blue-600 uppercase tracking-widest"></p>
                </div>
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="text-[11px] font-bold text-slate-400 uppercase ml-1">Số lượng</label>
                        <input type="number" id="qty" value="1" min="1" onchange="updateTotal()" class="w-full px-4 py-3 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-blue-500 focus:bg-white outline-none transition-all font-bold">
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[11px] font-bold text-slate-400 uppercase ml-1">Mã giảm giá</label>
                        <div class="flex space-x-2">
                            <input type="text" id="coupon" placeholder="CODE" class="w-full px-4 py-3 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-blue-500 focus:bg-white outline-none transition-all font-bold uppercase text-sm">
                            <button onclick="applyCoupon()" class="bg-slate-900 text-white p-3 rounded-2xl hover:bg-blue-600 transition-all">
                                <i data-lucide="ticket" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-slate-400 uppercase ml-1">Email nhận Key</label>
                    <input type="email" id="cust_email" placeholder="example@gmail.com" class="w-full px-4 py-3 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-blue-500 outline-none transition-all">
                </div>

                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold text-slate-400 uppercase ml-1">Số điện thoại</label>
                    <input type="tel" id="cust_phone" placeholder="09xxxxxxxx" class="w-full px-4 py-3 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-blue-500 outline-none transition-all">
                </div>
            </div>

            <div class="bg-slate-900 rounded-[2rem] p-6 text-white">
                <div class="space-y-2 text-sm opacity-70">
                    <div class="flex justify-between"><span>Đơn giá:</span><span id="txt-price"></span></div>
                    <div id="row-discount" class="hidden flex justify-between text-emerald-400"><span>Giảm giá:</span><span id="txt-discount"></span></div>
                </div>
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-slate-700">
                    <span class="font-bold">Tổng thanh toán:</span>
                    <span id="txt-total" class="text-3xl font-black text-blue-400"></span>
                </div>
            </div>

            <button onclick="confirmPayment()" id="btn-pay" class="w-full py-5 bg-blue-600 text-white rounded-[1.5rem] font-extrabold shadow-xl shadow-blue-200 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center space-x-2">
                <span>XÁC NHẬN THANH TOÁN</span>
                <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <div id="payment-view" class="hidden max-w-md mx-auto text-center space-y-8 py-10">
        <div class="space-y-2">
            <h3 class="text-2xl font-extrabold text-slate-800">Quét mã VietQR</h3>
            <p class="text-sm text-slate-500">Hệ thống sẽ tự động duyệt ngay khi nhận được tiền</p>
        </div>
        <div class="bg-white p-4 border-2 border-slate-100 rounded-[3rem] inline-block shadow-2xl relative">
            <img id="qr-img" src="" class="w-72 h-72 object-contain">
        </div>
        <div class="flex items-center justify-center space-x-3 text-blue-600 bg-blue-50 py-3 px-6 rounded-2xl mx-auto w-fit">
            <div class="spinner"></div>
            <span class="text-xs font-bold uppercase tracking-wider">Đang chờ tín hiệu ngân hàng...</span>
        </div>
        <button onclick="showCatalog()" class="text-slate-400 text-xs font-bold uppercase hover:text-slate-900 transition-colors">Hủy & Quay lại</button>
    </div>
</div>

<script>
    let allProducts = [];
    let selectedProduct = null;
    let discountPercent = 0;

    // Khởi tạo
    window.onload = async () => {
        lucide.createIcons();
        try {
            const res = await fetch('/api/get-all-products');
            allProducts = await res.json();
            renderCatalog();
        } catch (e) {
            console.error("Lỗi tải dữ liệu");
        }
    };

    function renderCatalog() {
        const list = document.getElementById('product-list');
        list.innerHTML = allProducts.map(p => `
            <div class="product-card bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col justify-between">
                <div class="text-center">
                    <img src="${p.image_url}" class="w-24 h-24 mx-auto mb-6 object-contain drop-shadow-xl">
                    <h3 class="text-xl font-extrabold text-slate-800 mb-2">${p.name}</h3>
                    <p class="text-slate-500 text-sm mb-6">${p.description}</p>
                </div>
                <div class="flex items-center justify-between pt-6 border-t border-slate-50">
                    <span class="text-2xl font-black text-blue-600">${p.price.toLocaleString()}đ</span>
                    <button onclick="openCheckout('${p.code}')" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-bold hover:bg-slate-900 transition-all shadow-lg shadow-blue-100">
                        Mua ngay
                    </button>
                </div>
            </div>
        `).join('');
        lucide.createIcons();
    }

    function openCheckout(code) {
        selectedProduct = allProducts.find(p => p.code === code);
        discountPercent = 0; // Reset giảm giá
        document.getElementById('catalog-view').classList.add('hidden');
        document.getElementById('checkout-view').classList.remove('hidden');
        
        // Đổ dữ liệu vào trang thanh toán
        document.getElementById('check-img').src = selectedProduct.image_url;
        document.getElementById('check-name').innerText = selectedProduct.name;
        document.getElementById('check-warranty').innerText = selectedProduct.warranty || "Bảo hành 24/7";
        document.getElementById('txt-price').innerText = selectedProduct.price.toLocaleString() + 'đ';
        updateTotal();
    }

    function showCatalog() {
        document.getElementById('checkout-view').classList.add('hidden');
        document.getElementById('payment-view').classList.add('hidden');
        document.getElementById('catalog-view').classList.remove('hidden');
    }

    function updateTotal() {
        const qty = parseInt(document.getElementById('qty').value) || 1;
        const subtotal = selectedProduct.price * qty;
        const discountAmt = subtotal * (discountPercent / 100);
        const total = subtotal - discountAmt;

        document.getElementById('txt-total').innerText = total.toLocaleString() + 'đ';
        if (discountPercent > 0) {
            document.getElementById('row-discount').classList.remove('hidden');
            document.getElementById('txt-discount').innerText = '-' + discountAmt.toLocaleString() + 'đ';
        } else {
            document.getElementById('row-discount').classList.add('hidden');
        }
    }

    async function applyCoupon() {
        const code = document.getElementById('coupon').value.trim();
        if (!code) return;
        try {
            const res = await fetch(`/api/check-coupon?code=${code}`);
            if (res.ok) {
                const data = await res.json();
                discountPercent = data.discount_percent;
                alert(`Thành công! Bạn được giảm ${discountPercent}%`);
                updateTotal();
            } else {
                alert("Mã giảm giá không tồn tại!");
            }
        } catch (e) {}
    }

    async function confirmPayment() {
        const email = document.getElementById('cust_email').value;
        const phone = document.getElementById('cust_phone').value;
        const total = document.getElementById('txt-total').innerText.replace(/\D/g,'');

        if (!email.includes('@') || phone.length < 10) {
            alert("Vui lòng nhập Email và Số điện thoại hợp lệ!");
            return;
        }

        const btn = document.getElementById('btn-pay');
        btn.disabled = true;
        btn.innerHTML = `<div class="spinner !border-white !border-t-transparent"></div>`;

        const orderId = "ORD" + Math.floor(100000 + Math.random() * 899999);

        try {
            const res = await fetch('/api/create-order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ order_id: orderId, email, phone, total })
            });

            if (res.ok) {
                // VietQR API Link (Thay STK của bạn ở đây)
                const STK = "123456789"; 
                const NGAN_HANG = "MB";
                const qrUrl = `https://img.vietqr.io/image/${NGAN_HANG}-${STK}-compact2.png?amount=${total}&addInfo=${orderId}_${phone}`;
                
                document.getElementById('qr-img').src = qrUrl;
                document.getElementById('checkout-view').classList.add('hidden');
                document.getElementById('payment-view').classList.remove('hidden');
            }
        } catch (e) {
            alert("Lỗi tạo đơn hàng!");
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
